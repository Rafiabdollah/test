<!DOCTYPE html>
<html>
<head>
  <title>IOT Client Panel</title>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f2f2f2;
    }
    h2 {
      color: #2c3e50;
    }
    .data-block {
      background: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-weight: bold;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:last-child {
      background-color: #e74c3c;
    }
    #log {
      margin-top: 20px;
      padding: 10px;
      background: #eaf2f8;
      border-left: 4px solid #3498db;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Client: POMPE SOLAIRE RABAT</h2>

  <div class="data-block">
    <p>üå°Ô∏è Temperature: <span id="temperature">--</span> ¬∞C</p>
    <p>‚öôÔ∏è Speed: <span id="speed">--</span> RPM</p>
    <p>üîå Status: <span id="status">--</span></p>
  </div>

  <button onclick="sendMotorCommand('on')">Start Motor</button>
  <button onclick="sendMotorCommand('off')">Stop Motor</button>

  <div id="log">üì° Waiting for MQTT messages...</div>
<hr><br>

<h3 style="cursor:pointer; color:#2c3e50;" onclick="toggleDonn√©es√âlectriques()">üìä Voir les donn√©es √âlectriques</h3>
<div id="Donn√©es√âlectriques" style="display:none; padding:15px; background:#fefefe; border:1px solid #ccc; border-radius:8px;">
    <p> Tension : <span id="Tension">--</span> ¬∞C</p>
    <p> Puissance g√©n√©r√©e : <span id="Puissance">--</span> RPM</p>
    <p> √âtat de la batterie : <span id="batterie">--</span></p>
    <p> Consommation √©lectrique : <span id="Consommation">--</span></p>
</div>
  
<h3 style="cursor:pointer; color:#2c3e50;" onclick="toggleDonn√©esPompe()">üìä Voir les Performances de la Pompe</h3>
<div id="Donn√©esPompe" style="display:none; padding:15px; background:#fefefe; border:1px solid #ccc; border-radius:8px;">
    <p> D√©bit d'eau : <span id="Tension">--</span> L/min</p>
    <p> Pression d'eau : <span id="Puissance">--</span> bar</p>
    <p> Temp√©rature du moteur : <span id="batterie">--</span>  ¬∞C</p>
    <p> √âtat de fonctionnement : <span id="Consommation">--</span></p>
</div>
  
<h3 style="cursor:pointer; color:#2c3e50;" onclick="toggleDonn√©esSolaires()">üìä Voir les Donn√©es Solaires</h3>
<div id="Donn√©esSolaires" style="display:none; padding:15px; background:#fefefe; border:1px solid #ccc; border-radius:8px;">
    <p> Ensoleillement  : <span id="Tension">--</span>  W/m¬≤</p>
    <p> Temp√©rature ambiante : <span id="Puissance">--</span> ¬∞C</p>
    <p> √âtat des panneaux solaires : <span id="batterie">--</span></p>
</div>
  
<h3 style="cursor:pointer; color:#2c3e50;" onclick="toggleDonn√©esStockage()">üìä Voir les Donn√©es de Stockage d'Eau</h3>
<div id="Donn√©esStockage" style="display:none; padding:15px; background:#fefefe; border:1px solid #ccc; border-radius:8px;">
    <p> Niveau d'eau  : <span id="Tension">--</span></p>
</div>

<h3 style="cursor:pointer; color:#2c3e50;" onclick="toggleDonn√©esMaintenance()">üìä Voir les Donn√©es Maintenance et S√©curit√©</h3>
<div id="Donn√©esMaintenance" style="display:none; padding:15px; background:#fefefe; border:1px solid #ccc; border-radius:8px;">
    <p> Heures de fonctionnement  : <span id="Tension">--</span>  H</p>
    <p> Alertes de panne : <span id="Puissance">--</span></p>
    <p> √âtat des connexions : <span id="batterie">--</span></p>
</div>

<h3 style="cursor:pointer; color:#2c3e50;" onclick="toggleDonn√©esCommunication()">üìä Voir les Donn√©es de Communication</h3>
<div id="Donn√©esCommunication" style="display:none; padding:15px; background:#fefefe; border:1px solid #ccc; border-radius:8px;">
    <p> √âtat de la connexion r√©seau  : <span id="Tension">--</span>  H</p>
    <p> Latence des donn√©es : <span id="Puissance">--</span></p>
    <p> Statut des mises √† jour logicielles : <span id="batterie">--</span></p>
</div> 
  
  <script>
    window.onload = function () {
      const broker = "wss://1b56fa9f5384446881ab36a7be8959fb.s1.eu.hivemq.cloud:8884/mqtt";
      const username = sessionStorage.getItem("mqttUsername");
      const password = sessionStorage.getItem("mqttPassword");

      if (!username || !password) {
        alert("Missing MQTT credentials. Please log in again.");
        window.location.href = "index.html";
        return;
      }

      const clientID = "client_" + Math.random().toString(16).substr(2, 8);
      const client = new Paho.Client(broker, clientID);

      client.onConnectionLost = function (responseObject) {
        logMessage("‚ùå Connection lost: " + responseObject.errorMessage);
      };

      client.onMessageArrived = function (message) {
        const topic = message.destinationName;
        const payload = message.payloadString;
        const timestamp = new Date().toLocaleTimeString();

        if (topic === "vfd/temperature") {
          document.getElementById("temperature").innerText = payload;
        } else if (topic === "vfd/speed") {
          document.getElementById("speed").innerText = payload;
        } else if (topic === "vfd/status") {
          document.getElementById("status").innerText = payload;
        } else if (topic === "vfd/status") {
          document.getElementById("Tension").innerText = payload;
        } else if (topic === "vfd/Tension") {
          document.getElementById("Puissance").innerText = payload;
        } else if (topic === "vfd/status") {
          document.getElementById("batterie").innerText = payload;
        } else if (topic === "vfd/Consommation") {
          document.getElementById("Consommation").innerText = payload;
        }
        
        logMessage(`üì• ${timestamp} ‚Äî [${topic}]: ${payload}`);
      };

      client.connect({
        useSSL: true,
        userName: username,
        password: password,
        onSuccess: function () {
          logMessage("‚úÖ Connected to MQTT broker.");
          client.subscribe("vfd/temperature");
          client.subscribe("vfd/speed");
          client.subscribe("vfd/status");
        },
        onFailure: function (err) {
          alert("MQTT connection failed: " + err.errorMessage);
        }
      });

      window.sendMotorCommand = function (command) {
        if (!client.isConnected()) {
          alert("Not connected to MQTT broker.");
          return;
        }
        const msg = new Paho.Message(command);
        msg.destinationName = "vfd/status";
        client.send(msg);
        const timestamp = new Date().toLocaleTimeString();
        logMessage(`üì§ ${timestamp} ‚Äî Sent command: "${command}" to vfd/status`);
      };

      function logMessage(text) {
        const logDiv = document.getElementById("log");
        logDiv.textContent = text + "\n" + logDiv.textContent;
      }
    };
        function toggleDonn√©es√âlectriques() {
  const panel = document.getElementById("Donn√©es√âlectriques");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
        function toggleDonn√©esPompe() {
  const panel = document.getElementById("Donn√©esPompe");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
        function toggleDonn√©esSolaires() {
  const panel = document.getElementById("Donn√©esSolaires");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
        function toggleDonn√©esStockage() {
  const panel = document.getElementById("Donn√©esStockage");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
        function toggleDonn√©esMaintenance() {
  const panel = document.getElementById("Donn√©esMaintenance");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
        function toggleDonn√©esCommunication() {
  const panel = document.getElementById("Donn√©esCommunication");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
  </script>
</body>
</html>
