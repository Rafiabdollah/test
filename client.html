<!DOCTYPE html>
<html>
<head>
  <title>IOT Client Panel</title>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f2f2f2;
    }
    h2 {
      color: #2c3e50;
    }
    .data-block {
      background: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-weight: bold;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:last-child {
      background-color: #e74c3c;
    }
    #log {
      margin-top: 20px;
      padding: 10px;
      background: #eaf2f8;
      border-left: 4px solid #3498db;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Client: POMPE SOLAIRE RABAT</h2>

  <div class="data-block">
    <p>üå°Ô∏è Temperature: <span id="temperature">--</span> ¬∞C</p>
    <p>‚öôÔ∏è Speed: <span id="speed">--</span> RPM</p>
    <p>üîå Status: <span id="status">--</span></p>
  </div>

  <button onclick="sendMotorCommand('on')">Start Motor</button>
  <button onclick="sendMotorCommand('off')">Stop Motor</button>

  <div id="log">üì° Waiting for MQTT messages...</div>

  <script>
    window.onload = function () {
      const broker = "wss://1b56fa9f5384446881ab36a7be8959fb.s1.eu.hivemq.cloud:8884/mqtt";
      const username = sessionStorage.getItem("mqttUsername");
      const password = sessionStorage.getItem("mqttPassword");

      if (!username || !password) {
        alert("Missing MQTT credentials. Please log in again.");
        window.location.href = "index.html";
        return;
      }

      const clientID = "client_" + Math.random().toString(16).substr(2, 8);
      const client = new Paho.Client(broker, clientID);

      client.onConnectionLost = function (responseObject) {
        logMessage("‚ùå Connection lost: " + responseObject.errorMessage);
      };

      client.onMessageArrived = function (message) {
        const topic = message.destinationName;
        const payload = message.payloadString;
        const timestamp = new Date().toLocaleTimeString();

        if (topic === "vfd/temperature") {
          document.getElementById("temperature").innerText = payload;
        } else if (topic === "vfd/speed") {
          document.getElementById("speed").innerText = payload;
        } else if (topic === "vfd/status") {
          document.getElementById("status").innerText = payload;
        }

        logMessage(`üì• ${timestamp} ‚Äî [${topic}]: ${payload}`);
      };

      client.connect({
        useSSL: true,
        userName: username,
        password: password,
        onSuccess: function () {
          logMessage("‚úÖ Connected to MQTT broker.");
          client.subscribe("vfd/temperature");
          client.subscribe("vfd/speed");
          client.subscribe("vfd/status");
        },
        onFailure: function (err) {
          alert("MQTT connection failed: " + err.errorMessage);
        }
      });

      window.sendMotorCommand = function (command) {
        if (!client.isConnected()) {
          alert("Not connected to MQTT broker.");
          return;
        }
        const msg = new Paho.Message(command);
        msg.destinationName = "vfd/status";
        client.send(msg);
        const timestamp = new Date().toLocaleTimeString();
        logMessage(`üì§ ${timestamp} ‚Äî Sent command: "${command}" to vfd/status`);
      };

      function logMessage(text) {
        const logDiv = document.getElementById("log");
        logDiv.textContent = text + "\n" + logDiv.textContent;
      }
    };
  </script>
</body>
</html>
