<!DOCTYPE html>
<html>
<head>
  <title>IOT Client Panel</title>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f2f2f2;
    }
    h2 {
      color: #2c3e50;
    }
    .data-block {
      background: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-weight: bold;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:last-child {
      background-color: #e74c3c;
    }
    #log {
      margin-top: 20px;
      padding: 10px;
      background: #eaf2f8;
      border-left: 4px solid #3498db;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Client: POMPE SOLAIRE RABAT</h2>

  <div class="data-block">
    <p>üå°Ô∏è Temperature: <span id="temperature">--</span> ¬∞C</p>
    <p>‚öôÔ∏è Speed: <span id="speed">--</span> RPM</p>
    <p>üîå Status: <span id="status">--</span></p>
  </div>

  <button onclick="sendMotorCommand('on')">Start Motor</button>
  <button onclick="sendMotorCommand('off')">Stop Motor</button>

  <div id="log">üì° Waiting for MQTT messages...</div>
<hr><br>

<h3 style="cursor:pointer; color:#2c3e50;" onclick="toggleDetails()">üìä Voir les donn√©es avanc√©es</h3>

<div id="detailsPanel" style="display:none; padding:15px; background:#fefefe; border:1px solid #ccc; border-radius:8px;">
  <h4>1. Donn√©es √âlectriques</h4>
  <ul>
    <li>Tension et courant (entr√©e/sortie du panneau solaire, batterie, pompe)</li>
    <li>Puissance g√©n√©r√©e par les panneaux solaires</li>
    <li>√âtat de la batterie (niveau de charge, tension, courant de charge/d√©charge)</li>
    <li>Consommation √©lectrique de la pompe</li>
  </ul>

  <h4>2. Performances de la Pompe</h4>
  <ul>
    <li>D√©bit d'eau (en m¬≥/h ou L/min) ‚Äì Capteur de d√©bit</li>
    <li>Pression d'eau (en bar ou psi) ‚Äì Capteur de pression</li>
    <li>Temp√©rature du moteur (pour √©viter la surchauffe)</li>
    <li>√âtat de fonctionnement (ON/OFF, mode veille)</li>
  </ul>

  <h4>3. Donn√©es Solaires et Environnementales</h4>
  <ul>
    <li>Ensoleillement (irradiance solaire en W/m¬≤)</li>
    <li>Temp√©rature ambiante</li>
    <li>√âtat des panneaux solaires (propret√©, ombrage, d√©tection de d√©fauts)</li>
  </ul>

  <h4>4. Surveillance du R√©servoir/Stockage d'Eau</h4>
  <ul>
    <li>Niveau d'eau (capteur ultrasonique ou √† flotteur)</li>
    <li>Qualit√© de l'eau (pH, turbidit√© si n√©cessaire)</li>
  </ul>

  <h4>5. Donn√©es de Maintenance et S√©curit√©</h4>
  <ul>
    <li>Heures de fonctionnement (maintenance pr√©ventive)</li>
    <li>Alertes de panne (surchauffe, faible d√©bit, coupure courant)</li>
    <li>√âtat des connexions (court-circuit ou circuit ouvert)</li>
  </ul>

  <h4>6. Donn√©es de Communication IoT</h4>
  <ul>
    <li>√âtat de la connexion r√©seau (4G/LoRa/WiFi)</li>
    <li>Latence des donn√©es</li>
    <li>Statut des mises √† jour logicielles</li>
  </ul>

  <h4>7. Donn√©es √ânerg√©tiques et Efficacit√©</h4>
  <ul>
    <li>Rendement du syst√®me (√©nergie solaire/√©nergie utilis√©e)</li>
    <li>Autonomie de la batterie (temps restant avant recharge)</li>
  </ul>
</div>
  <script>
    window.onload = function () {
      const broker = "wss://1b56fa9f5384446881ab36a7be8959fb.s1.eu.hivemq.cloud:8884/mqtt";
      const username = sessionStorage.getItem("mqttUsername");
      const password = sessionStorage.getItem("mqttPassword");

      if (!username || !password) {
        alert("Missing MQTT credentials. Please log in again.");
        window.location.href = "index.html";
        return;
      }

      const clientID = "client_" + Math.random().toString(16).substr(2, 8);
      const client = new Paho.Client(broker, clientID);

      client.onConnectionLost = function (responseObject) {
        logMessage("‚ùå Connection lost: " + responseObject.errorMessage);
      };

      client.onMessageArrived = function (message) {
        const topic = message.destinationName;
        const payload = message.payloadString;
        const timestamp = new Date().toLocaleTimeString();

        if (topic === "vfd/temperature") {
          document.getElementById("temperature").innerText = payload;
        } else if (topic === "vfd/speed") {
          document.getElementById("speed").innerText = payload;
        } else if (topic === "vfd/status") {
          document.getElementById("status").innerText = payload;
        }

        logMessage(`üì• ${timestamp} ‚Äî [${topic}]: ${payload}`);
      };

      client.connect({
        useSSL: true,
        userName: username,
        password: password,
        onSuccess: function () {
          logMessage("‚úÖ Connected to MQTT broker.");
          client.subscribe("vfd/temperature");
          client.subscribe("vfd/speed");
          client.subscribe("vfd/status");
        },
        onFailure: function (err) {
          alert("MQTT connection failed: " + err.errorMessage);
        }
      });

      window.sendMotorCommand = function (command) {
        if (!client.isConnected()) {
          alert("Not connected to MQTT broker.");
          return;
        }
        const msg = new Paho.Message(command);
        msg.destinationName = "vfd/status";
        client.send(msg);
        const timestamp = new Date().toLocaleTimeString();
        logMessage(`üì§ ${timestamp} ‚Äî Sent command: "${command}" to vfd/status`);
      };

      function logMessage(text) {
        const logDiv = document.getElementById("log");
        logDiv.textContent = text + "\n" + logDiv.textContent;
      }
    };
    function toggleDetails() {
  const panel = document.getElementById("detailsPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
  </script>
</body>
</html>
