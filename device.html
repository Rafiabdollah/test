<!DOCTYPE html>
<html>
<head>
  <title>MQTT Device Panel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input {
      width: 100px;
    }
    #allMessages {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      max-height: 300px;
      overflow-y: auto;
    }
    p {
      margin: 5px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Device: Publish Data</h2>

  <label>Temperature (Â°C):</label><br>
  <input type="number" id="tempInput"><br><br>

  <label>Speed (RPM):</label><br>
  <input type="number" id="speedInput"><br><br>

  <label>Status:</label><br>
  <input type="text" id="statusInput"><br><br>

  <button onclick="publishData()">Send Data</button>

  <h3>All Incoming MQTT Messages</h3>
  <div id="allMessages">
    <p>Waiting for messages...</p>
  </div>

  <script>
    const broker = "wss://1b56fa9f5384446881ab36a7be8959fb.s1.eu.hivemq.cloud:8884/mqtt";
    const username = sessionStorage.getItem("mqttUsername");
    const password = sessionStorage.getItem("mqttPassword");
    const clientID = "device_" + Math.random().toString(16).substr(2, 8);

    const client = new Paho.MQTT.Client(broker, clientID);

    client.onConnectionLost = function (responseObject) {
      console.log("Connection lost:", responseObject.errorMessage);
    };

    client.onMessageArrived = function (message) {
      const topic = message.destinationName;
      const payload = message.payloadString;
      console.log("Incoming message:", topic, payload);

      const messageElement = document.createElement("p");
      messageElement.textContent = `ðŸ“© Topic: ${topic} â€” Message: ${payload}`;
      document.getElementById("allMessages").prepend(messageElement);
    };

    client.connect({
      useSSL: true,
      userName: username,
      password: password,
      onSuccess: () => {
        console.log("Connected to MQTT as Device");
        client.subscribe("vfd/#"); // Subscribe to all topics under "vfd/"
      },
      onFailure: (err) => {
        alert("MQTT connection failed: " + err.errorMessage);
      },
    });

    function publishData() {
      const temp = document.getElementById("tempInput").value;
      const speed = document.getElementById("speedInput").value;
      const status = document.getElementById("statusInput").value;

      if (temp) {
        const msg = new Paho.MQTT.Message(temp);
        msg.destinationName = "vfd/temperature";
        client.send(msg);
      }

      if (speed) {
        const msg = new Paho.MQTT.Message(speed);
        msg.destinationName = "vfd/speed";
        client.send(msg);
      }

      if (status) {
        const msg = new Paho.MQTT.Message(status);
        msg.destinationName = "vfd/status";
        client.send(msg);
      }

      alert("Data sent!");
    }
  </script>
</body>
</html>
